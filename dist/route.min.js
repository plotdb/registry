!function(){var c,a,u,l,s;c=require("fs"),a=require("fs-extra"),u=require("path"),require("@plotdb/block"),l=require("lderror"),s=function(e){var r=e.provider,i=e.id,t=e.root,s={},o={};return i=u.resolve(u.join("/",i)).substring(1),Promise.resolve().then(function(){var e,n;return s[404]=u.join(t,i)+".404",s.full=u.join(t,i),s.dir=u.dirname(s.full),s.full&&s.dir?/^[-_a-zA-Z0-9@./]+$/.exec(i)?(e=i.split("/"),function(e,n){var r,i={}.hasOwnProperty;for(r in n)i.call(n,r)&&(e[r]=n[r])}(o,3<e.length?{name:e[0]+"/"+e[1],version:e[2],path:e.slice(3).join("/")}:{name:e[0],version:e[1],path:e.slice(2).join("/")}),/:/.exec(o.name)&&(n=o.name.split(":"),o.ns=n[0],o.name=n[1]),o.name&&o.version&&o.path?(s.base=(o.ns?o.ns+":":"")+o.name,s.main=u.join(t,s.base,"main"),s.version=u.join(t,s.base,o.version,".version"),"main"!==(n=o.version)&&"latest"!==n||(o.version=c.existsSync(s.version)?c.readFileSync(s.version).toString():"master"),r.fetch(o).then(function(e){var n,r=e.version,i=e.content;return r=u.resolve(u.join("/",r)).substring(1),a.ensureDirSync(s.dir),c.existsSync(s.version)&&c.readFileSync(s.version).toString()!==r&&(a.removeSync(s.dir),a.ensureDirSync(s.dir)),c.writeFileSync(s.full,i),c.writeFileSync(s.version,r),(e=c.existsSync(s.base)?c.readdirSync(s.base):[]).sort(function(e,n){return e<n?1:n<e?-1:0}),e[0]&&!(r>e[0])&&(n=c.existsSync(s.main))||(n&&c.removeSync(s.main),r=u.join(t,s.base,r),a.ensureSymlink(r,s.main)),i})):l.reject(404)):l.reject(404):l(400)}).catch(function(e){return 998===l.id(e)?l.reject(404):404!==l.id(e)?Promise.reject(e):(a.ensureDirSync(s.dir),c.writeFileSync(s[404],"404"),l.reject(404))})},module.exports=function(e){var i=e.provider,t=e.root;return t.pub.endsWith("/")||(t.pub=t.pub+"/"),function(e,n){var r=e.originalUrl.replace(t.pub,"").replace(/[#?].*$/,"");return s({provider:i,id:r,root:t.fs}).then(function(){return n.set({"X-Accel-Redirect":u.join(t.internal,r)}),n.send()}).catch(function(e){return 404!==l.id(e)&&(console.log(e),n.status(500).send()),n.status(404).send()})}}}.call(this);
