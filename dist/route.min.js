!function(){var s=require("fs"),u=require("fs-extra"),a=require("path"),l=(require("@plotdb/block"),require("lderror")),o=function(e){var n=e.provider,i=e.id,e=e.root,r=a.join(e,a.resolve(a.join("/",i)).substring(1))+".404",t=a.join(e,a.resolve(a.join("/",i)).substring(1)),o=a.dirname(t),c=a.join(o,".version");return Promise.resolve().then(function(){return t&&o?u.ensureDir(o):l(400)}).then(function(){var e,r;return/^[-:a-zA-Z0-9@./]+$/.exec(i)?(e=3<(r=i.split("/")).length?{name:r[0]+"/"+r[1],version:r[2],path:r.slice(3).join("/")}:{name:r[0],version:r[1],path:r.slice(2).join("/")},/:/.exec(e.name)&&(r=e.name.split(":"),e.ns=r[0],e.name=r[1]),e.name&&e.version&&e.path?n.fetch(e).then(function(e){var r=e.version,e=e.content;return s.existsSync(c)&&s.readFileSync(c)!==r&&(u.removeSync(o),u.ensureDirSync(o)),s.writeFileSync(t,e),s.writeFileSync(c,r),e}):l.reject(404)):l.reject(404)}).catch(function(e){return 404!==l.id(e)?Promise.reject(e):(s.writeFileSync(r,"404"),l.reject(404))})};module.exports=function(e){var i=e.provider,t=e.root;return t.pub.endsWith("/")||(t.pub=t.pub+"/"),function(e,r){var n=e.originalUrl.replace(t.pub,"");return o({provider:i,id:n,root:t.fs}).then(function(){return r.set({"X-Accel-Redirect":a.join(t.internal,n)}),r.send()}).catch(function(e){return 404!==l.id(e)&&(console.log(e),r.status(500).send()),r.status(404).send()})}}}.call(this);
