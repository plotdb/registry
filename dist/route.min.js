!function(){var c,a,u,l,o;c=require("fs"),a=require("fs-extra"),u=require("path"),require("@plotdb/block"),l=require("lderror"),o=function(e){var n=e.provider,i=e.id,t=e.root,o={},s={};return i=u.resolve(u.join("/",i)).substring(1),Promise.resolve().then(function(){var e,r;if(o[404]=u.join(t,i)+".404",o.full=u.join(t,i),o.dir=u.dirname(o.full),!o.full||!o.dir)return l(400);if(!/^[-_a-zA-Z0-9@./]+$/.exec(i))return l.reject(404);if(e=i.split("/"),function(e,r){var n,i={}.hasOwnProperty;for(n in r)i.call(r,n)&&(e[n]=r[n])}(s,3<e.length?{name:e[0]+"/"+e[1],version:e[2],path:e.slice(3).join("/")}:{name:e[0],version:e[1],path:e.slice(2).join("/")}),/:/.exec(s.name)&&(r=s.name.split(":"),s.ns=r[0],s.name=r[1]),!(s.name&&s.version&&s.path))return l.reject(404);if(o.base=(s.ns?s.ns+":":"")+s.name,o.main=u.join(t,o.base,"main"),o.version=u.join(t,o.base,s.version,".version"),"main"===(r=s.version)||"latest"===r){if(!c.existsSync(o.version))return l.reject(998);s.version=c.readFileSync(o.version).toString()}return n.fetch(s).then(function(e){var r,n=e.version,i=e.content;return n=u.resolve(u.join("/",n)).substring(1),a.ensureDirSync(o.dir),c.existsSync(o.version)&&c.readFileSync(o.version).toString()!==n&&(a.removeSync(o.dir),a.ensureDirSync(o.dir)),c.writeFileSync(o.full,i),c.writeFileSync(o.version,n),(e=c.existsSync(o.base)?c.readdirSync(o.base):[]).sort(function(e,r){return e<r?1:r<e?-1:0}),e[0]&&!(n>e[0])&&(r=c.existsSync(o.main))||(r&&c.removeSync(o.main),n=u.join(t,o.base,n),a.ensureSymlink(n,o.main)),i})}).catch(function(e){return 998===l.id(e)?l.reject(404):404!==l.id(e)?Promise.reject(e):(c.writeFileSync(o[404],"404"),l.reject(404))})},module.exports=function(e){var i=e.provider,t=e.root;return t.pub.endsWith("/")||(t.pub=t.pub+"/"),function(e,r){var n=e.originalUrl.replace(t.pub,"");return o({provider:i,id:n,root:t.fs}).then(function(){return r.set({"X-Accel-Redirect":u.join(t.internal,n)}),r.send()}).catch(function(e){return 404!==l.id(e)&&(console.log(e),r.status(500).send()),r.status(404).send()})}}}.call(this);
