!function(){var s=require("fs"),u=require("fs-extra"),a=require("path"),l=(require("@plotdb/block"),require("lderror")),o=function(e){var r=e.provider,t=e.id,e=e.root,n=a.join(e,a.resolve(a.join("/",t)).substring(1))+".404",i=a.join(e,a.resolve(a.join("/",t)).substring(1)),o=a.dirname(i),c=a.join(o,".version");return Promise.resolve().then(function(){return i&&o?u.ensureDir(o):l(400)}).then(function(){var e,n;return/^[-:a-zA-Z0-9@./]+$/.exec(t)?(e=3<(n=t.split("/")).length?{name:n[0]+"/"+n[1],version:n[2],path:n.slice(3).join("/")}:{name:n[0],version:n[1],path:n.slice(2).join("/")},/:/.exec(e.name)&&(n=e.name.split(":"),e.ns=n[0],e.name=n[1]),e.name&&e.version&&e.path?r.fetch(e).then(function(e){var n=e.version,e=e.content;return s.existsSync(c)&&s.readFileSync(c)!==n&&(u.removeSync(o),u.ensureDirSync(o)),s.writeFileSync(i,e),s.writeFileSync(c,n),e}):l.reject(404)):l.reject(404)}).catch(function(e){return console.log(e),s.writeFileSync(n,"404"),l.reject(404)})};module.exports=function(e){var t=e.provider,i=e.root;return i.pub.endsWith("/")||(i.pub=i.pub+"/"),function(e,n){var r=e.originalUrl.replace(i.pub,"");return o({provider:t,id:r,root:i.fs}).then(function(){return n.set({"X-Accel-Redirect":a.join(i.internal,r)}),n.send()}).catch(function(e){return 404!==l.id(e)&&(console.log(e),n.status(500).send()),n.status(404).send()})}}}.call(this);
