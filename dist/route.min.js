!function(){var a=require("fs"),d=require("fs-extra"),v=require("path"),f=(require("@plotdb/block"),require("lderror")),o=function(e){var s=e.provider,u=e.id,l=e.root;return Promise.resolve().then(function(){var e,r,n,i,t,o,c;return/^[a-zA-Z0-9@./]+$/.exec(u)?(e=u.split("/"),n=3<e.length?(r=e[0]+"/"+e[1],i=e[2],e.slice(3).join("/")):(r=e[0],i=e[1],e.slice(2).join("/")),i={name:r,version:i,path:n},t=v.join(l,v.resolve(v.join("/",u)).substring(1))+".404",(n=v.join(l,v.resolve(v.join("/",u)).substring(1)))?(o=v.dirname(n),c=v.join(o,".version"),d.ensureDirSync(o),s.fetch(i).then(function(e){var r=e.version,e=e.content;return a.existsSync(c)&&a.readFileSync(c)!==r&&(d.removeSync(o),d.ensureDirSync(o)),a.writeFileSync(n,e),a.writeFileSync(c,r),e}).catch(function(){return a.writeFileSync(t,"404"),f.reject(404)})):f(400)):f.reject(404)})};module.exports=function(e){var i=e.provider,t=e.root;return t.pub.endsWith("/")||(t.pub=t.pub+"/"),function(e,r){var n=e.originalUrl.replace(t.pub,"");return o({provider:i,id:n,root:t.fs}).then(function(){return r.set({"X-Accel-Redirect":v.join(t.internal,n)}),r.send()}).catch(function(e){return 404!==f.id(e)&&(console.log(e),r.status(500).send()),r.status(404).send()})}}}.call(this);
