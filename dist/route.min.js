!function(){var d=require("fs"),v=require("fs-extra"),p=require("path"),f=(require("@plotdb/block"),require("lderror")),o=function(e){var u=e.provider,l=e.id,a=e.root;return Promise.resolve().then(function(){var e,n,r,i,t,o,c,s;return/^[-:a-zA-Z0-9@./]+$/.exec(l)?(r=l.split("/"),n=3<r.length?(e=r[0]+"/"+r[1],t=r[2],r.slice(3).join("/")):(e=r[0],t=r[1],r.slice(2).join("/")),/:/.exec(e)&&(i=(r=e.split(":"))[0],e=r[1]),e&&t&&p?(t={ns:i,name:e,version:t,path:n},o=p.join(a,p.resolve(p.join("/",l)).substring(1))+".404",(n=p.join(a,p.resolve(p.join("/",l)).substring(1)))?(c=p.dirname(n),s=p.join(c,".version"),v.ensureDirSync(c),u.fetch(t).then(function(e){var r=e.version,e=e.content;return d.existsSync(s)&&d.readFileSync(s)!==r&&(v.removeSync(c),v.ensureDirSync(c)),d.writeFileSync(n,e),d.writeFileSync(s,r),e}).catch(function(){return d.writeFileSync(o,"404"),f.reject(404)})):f(400)):f.reject(404)):f.reject(404)})};module.exports=function(e){var i=e.provider,t=e.root;return t.pub.endsWith("/")||(t.pub=t.pub+"/"),function(e,r){var n=e.originalUrl.replace(t.pub,"");return o({provider:i,id:n,root:t.fs}).then(function(){return r.set({"X-Accel-Redirect":p.join(t.internal,n)}),r.send()}).catch(function(e){return 404!==f.id(e)&&(console.log(e),r.status(500).send()),r.status(404).send()})}}}.call(this);
