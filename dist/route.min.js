!function(){var l=require("fs"),v=require("fs-extra"),d=require("path"),j=(require("@plotdb/block"),require("lderror")),o=function(e){var r=e.provider,i=e.id,s=e.root,n=d.join(s,d.resolve(d.join("/",i)).substring(1))+".404",c=d.join(s,d.resolve(d.join("/",i)).substring(1)),u=d.dirname(c),a=d.join(u,".version");return Promise.resolve().then(function(){return c&&u?v.ensureDir(u):j(400)}).then(function(){var e,o,n;return/^[-:a-zA-Z0-9@./]+$/.exec(i)?(e=i.split("/"),o=3<e.length?{name:e[0]+"/"+e[1],version:e[2],path:e.slice(3).join("/")}:{name:e[0],version:e[1],path:e.slice(2).join("/")},/:/.exec(o.name)&&(n=o.name.split(":"),o.ns=n[0],o.name=n[1]),o.name&&o.version&&o.path?"main"===(n=o.version)||"latest"===n?j.reject(998):r.fetch(o).then(function(e){var n,r,i=e.version,t=e.content;return l.existsSync(a)&&l.readFileSync(a)!==i&&(v.removeSync(u),v.ensureDirSync(u)),l.writeFileSync(c,t),l.writeFileSync(a,i),n=(o.ns?o.ns+":":"")+o.name,r=d.join(s,d.resolve(d.join("/",n,"main")).substring(1)),(e=l.existsSync(n)?l.readdirSync(n):[]).sort(function(e,n){return e<n?1:n<e?-1:0}),(!e[0]||i>e[0])&&(l.existsSync(r)&&l.removeSync(r),i=d.join(s,d.resolve(d.join("/",n,i)).substring(1)),v.ensureSymlink(i,r)),t}):j.reject(404)):j.reject(404)}).catch(function(e){return 998===j.id(e)?j.reject(404):404!==j.id(e)?Promise.reject(e):(l.writeFileSync(n,"404"),j.reject(404))})};module.exports=function(e){var i=e.provider,t=e.root;return t.pub.endsWith("/")||(t.pub=t.pub+"/"),function(e,n){var r=e.originalUrl.replace(t.pub,"");return o({provider:i,id:r,root:t.fs}).then(function(){return n.set({"X-Accel-Redirect":d.join(t.internal,r)}),n.send()}).catch(function(e){return 404!==j.id(e)&&(console.log(e),n.status(500).send()),n.status(404).send()})}}}.call(this);
